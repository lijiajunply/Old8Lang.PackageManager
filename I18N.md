# 国际化 (i18n) 支持文档

Old8Lang Package Manager 现已支持多语言国际化功能,包括后端 API 和前端 Web 界面。

## 支持的语言

- 英语 (English) - `en`
- 简体中文 (Simplified Chinese) - `zh-CN`

## 后端国际化

### 架构

后端使用 ASP.NET Core 的内置本地化支持,包括:

- **资源文件**: `Resources/Messages.resx` (英语), `Resources/Messages.zh-CN.resx` (中文)
- **本地化服务**: `ILocalizationService` 接口和 `LocalizationService` 实现
- **语言中间件**: 自动检测和设置请求语言

### 语言检测优先级

1. 查询参数: `?lang=en` 或 `?lang=zh-CN`
2. `Accept-Language` HTTP 头

### 示例请求

```bash
# 使用查询参数
curl http://localhost:5000/v3/search?q=test&lang=zh-CN

# 使用 HTTP 头
curl -H "Accept-Language: zh-CN" http://localhost:5000/v3/search?q=test
```

### 添加新语言

1. 创建新的资源文件,例如 `Resources/Messages.ja.resx` (日语)
2. 复制 `Messages.resx` 中的所有键
3. 翻译值为目标语言
4. 在 `Program.cs` 中添加新语言到 `supportedCultures`
5. 在 `LanguageMiddleware.cs` 中添加新语言代码

### 在控制器中使用

```csharp
public class MyController : ControllerBase
{
    private readonly ILocalizationService _localization;

    public MyController(ILocalizationService localization)
    {
        _localization = localization;
    }

    public IActionResult MyAction()
    {
        var message = _localization.GetString("MyMessageKey");
        return Ok(new { message });
    }
}
```

## 前端国际化

### 架构

前端使用 Vue I18n v9,包括:

- **语言文件**: `src/i18n/locales/en.ts` (英语), `src/i18n/locales/zh-CN.ts` (中文)
- **i18n 配置**: `src/i18n/index.ts`
- **语言切换组件**: `src/components/LanguageSwitcher.vue`

### 语言检测和存储

1. 检查 localStorage 中的 `language` 键
2. 如果未设置,使用浏览器语言 (`navigator.language`)
3. 用户选择的语言会保存到 localStorage

### 在组件中使用

```vue
<template>
  <div>
    <h1>{{ t('home.title') }}</h1>
    <p>{{ t('home.subtitle') }}</p>
  </div>
</template>

<script setup lang="ts">
import { useI18n } from 'vue-i18n'

const { t } = useI18n()
</script>
```

### 添加新翻译

1. 在 `src/i18n/locales/en.ts` 中添加新的键值对
2. 在 `src/i18n/locales/zh-CN.ts` 中添加对应的翻译
3. 在组件中使用 `t('your.new.key')`

### 添加新语言

1. 创建新的语言文件,例如 `src/i18n/locales/ja.ts`
2. 复制 `en.ts` 的结构并翻译所有值
3. 在 `src/i18n/index.ts` 中导入并注册:

```typescript
import ja from './locales/ja'

const i18n = createI18n({
  messages: {
    en,
    'zh-CN': zhCN,
    ja,
  },
})
```

4. 在 `LanguageSwitcher.vue` 中添加新语言选项:

```typescript
const languageOptions = computed<LanguageOption[]>(() => [
  { label: 'English', key: 'en' },
  { label: '简体中文', key: 'zh-CN' },
  { label: '日本語', key: 'ja' },
])
```

## 语言切换

### 前端

用户可以通过页面头部的语言切换器切换语言:

1. 点击语言图标
2. 从下拉菜单中选择语言
3. 页面会自动重新加载以应用新语言

### 后端 API

API 会自动根据请求头或查询参数返回相应语言的错误消息和响应。

## 翻译覆盖范围

### 后端

- ✅ API 错误消息
- ✅ 包管理操作响应
- ✅ 质量评分消息
- ✅ 依赖关系消息
- ✅ 服务索引描述

### 前端

- ✅ 导航菜单
- ✅ 通用按钮和操作
- ✅ 包详情页面
- ✅ 上传页面
- ✅ 个人资料页面
- ✅ 错误消息
- ⚠️ 某些动态内容可能需要进一步翻译

## 测试国际化

### 后端测试

```bash
# 测试中文响应
curl -H "Accept-Language: zh-CN" http://localhost:5000/v3/package/nonexistent

# 测试英文响应
curl -H "Accept-Language: en" http://localhost:5000/v3/package/nonexistent
```

### 前端测试

1. 打开浏览器开发者工具
2. 在控制台中运行: `localStorage.setItem('language', 'zh-CN')`
3. 刷新页面查看中文界面
4. 运行: `localStorage.setItem('language', 'en')` 切换回英语

## 最佳实践

### 后端

1. 所有面向用户的消息都应使用 `ILocalizationService`
2. 错误代码使用英文常量,便于程序处理
3. 日志消息保持英文,便于开发和调试

### 前端

1. 所有硬编码文本都应使用 `t()` 函数
2. 使用有意义的嵌套键,如 `package.details.version`
3. 动态内容(如日期、数字)使用适当的格式化函数

## 贡献翻译

欢迎社区贡献新语言或改进现有翻译:

1. Fork 仓库
2. 添加或修改语言文件
3. 测试翻译
4. 提交 Pull Request

## 常见问题

### Q: 如何设置默认语言?

**后端**: 在 `Program.cs` 中修改 `DefaultRequestCulture`

```csharp
options.DefaultRequestCulture = new RequestCulture("zh-CN");
```

**前端**: 在 `src/i18n/index.ts` 中修改 `fallbackLocale`

### Q: 浏览器语言检测不工作?

检查浏览器的语言设置,确保包含所支持的语言。前端会尝试匹配主语言代码(如 `zh` 匹配 `zh-CN`)。

### Q: 如何禁用自动重新加载?

在 `LanguageSwitcher.vue` 中注释掉 `window.location.reload()` 行,但这可能导致某些组件不更新。

## 技术细节

### 依赖项

**后端**:
- Microsoft.Extensions.Localization (内置于 .NET)

**前端**:
- vue-i18n@9

### 文件结构

```
Old8Lang.PackageManager.Server/
├── Resources/
│   ├── Messages.cs
│   ├── Messages.resx
│   └── Messages.zh-CN.resx
├── Services/
│   └── LocalizationService.cs
└── Middleware/
    └── LanguageMiddleware.cs

frontend/src/
├── i18n/
│   ├── index.ts
│   └── locales/
│       ├── en.ts
│       └── zh-CN.ts
└── components/
    └── LanguageSwitcher.vue
```

## 参考链接

- [Vue I18n 文档](https://vue-i18n.intlify.dev/)
- [ASP.NET Core 本地化](https://docs.microsoft.com/aspnet/core/fundamentals/localization)
- [ISO 639-1 语言代码](https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes)
